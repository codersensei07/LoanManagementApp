module Test.LoanRequestTest where

import DA.Test
import DA.Next
import DA.List (fold)
import DA.Time
import DA.Date
import DA.Text
import DA.Optional
import DA.Map
import DA.Set
import DA.Time


-- Test Script - Implement a DAML test script that simulates the loan request and approval workflow.
-- a) A `LoanRequest` contract can be created by the borrower.
-- b) The bank can approve the `LoanRequest` using the `ApproveRequest` choice.
-- c) Upon approval, the `LoanRequest` contract is archived.
-- d) A new `Loan` contract is created with the borrower and bank as signatories.



script LoanRequestTest : Test
  with
    borrower : Party
    bank : Party
  where
    signatories = [borrower, bank]
    key = "loan-request-test"
    maintainers = [borrower, bank]
  do
    -- Step 1: Create a LoanRequest contract
    let loanRequest = LoanRequest with
          borrower = borrower
          bank = bank
          amount = 10000.0
          interestRate = 5.0
          term = 12 months

    -- Step 2: Approve the LoanRequest contract
    let approveRequest = ApproveRequest with
          requestId = loanRequest.id

    -- Step 3: Archive the LoanRequest contract and create a new Loan contract
    let loanContract = Loan with
          borrower = borrower
          bank = bank
          amount = loanRequest.amount
          interestRate = loanRequest.interestRate
          term = loanRequest.term

    -- Step 4: Verify the Loan contract is created and the LoanRequest is archived.
    let archivedLoanRequest = archive loanRequest
    let createdLoan = create loanContract
    let verifyLoan = verify createdLoan
    let verifyArchivedRequest = verify archivedLoanRequest
    -- Step 5: Check the Loan contract details
    let checkLoanDetails = do
          assert (createdLoan.borrower == borrower)
          assert (createdLoan.bank == bank)
          assert (createdLoan.amount == loanRequest.amount)
          assert (createdLoan.interestRate == loanRequest.interestRate)
          assert (createdLoan.term == loanRequest.term)
    -- Step 6: Check the LoanRequest contract is archived
    let checkArchivedRequest = do
          assert (archivedLoanRequest == None)
    -- Step 7: Run the test
    runTest do
      -- Create the LoanRequest contract
      create loanRequest
      -- Approve the LoanRequest contract
      approveRequest
      -- Archive the LoanRequest contract and create a new Loan contract
      archive loanRequest
      create loanContract
      -- Verify the Loan contract is created and the LoanRequest is archived.
      verifyLoan
      verifyArchivedRequest
      -- Check the Loan contract details
      checkLoanDetails
      -- Check the LoanRequest contract is archived
      checkArchivedRequest
    return ()

